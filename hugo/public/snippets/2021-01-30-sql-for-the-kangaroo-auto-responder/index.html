<!DOCTYPE html>
<html lang="en-us">

<head>

  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="generator" content="Source Themes Academic 4.8.0">

  

  
  
  
  
  
    
    
    
  
  

  <meta name="author" content="David Bieber">

  
  
  
    
  
  <meta name="description" content="I turned on the Kangaroo Auto-responder this morning. The rules for when to send a kangaroo ðŸ¦˜ are as follows:
You get a kangaroo if theÂ most-recentÂ message in our chat (ignoring trivial messages from you) isÂ non-trivial,Â read-by-me,Â written-by-you,Â not a response, andÂ eight-hours old.
Let&rsquo;s look at each of these criteria in more detail.
Most-recent message The criteria are being applied to the most recent message in our chat ignoring trivial messages from you.">

  
  <link rel="alternate" hreflang="en-us" href="https://davidbieber.com/snippets/2021-01-30-sql-for-the-kangaroo-auto-responder/">

  


  
  
  
  <meta name="theme-color" content="#2962ff">
  

  
  

  
  
  
  
    
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/academicons/1.8.6/css/academicons.min.css" integrity="sha256-uFVgMKfistnJAfoCUQigIl+JfUaP47GrRKjf6CTPVmw=" crossorigin="anonymous">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.0-1/css/all.min.css" integrity="sha256-4w9DunooKSr3MFXHXWyFER38WmPdm361bQS/2KUWZbU=" crossorigin="anonymous">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/fancybox/3.5.7/jquery.fancybox.min.css" integrity="sha256-Vzbj7sDDS/woiFS3uNKo8eIuni59rjyNGtXfstRzStA=" crossorigin="anonymous">

    
    
    
      
    
    
      
      
        
          <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.18.1/styles/github.min.css" crossorigin="anonymous" title="hl-light">
          <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.18.1/styles/dracula.min.css" crossorigin="anonymous" title="hl-dark" disabled>
        
      
    

    

    

    
    
      

      
      

      
    
      

      
      

      
    
      

      
      

      
    
      

      
      

      
    
      

      
      

      
    
      

      
      

      
    
      

      
      

      
    
      

      
      

      
    
      

      
      

      
    
      

      
      

      
    
      

      
      

      
        <script src="https://cdnjs.cloudflare.com/ajax/libs/lazysizes/5.1.2/lazysizes.min.js" integrity="sha256-Md1qLToewPeKjfAHU1zyPwOutccPAm5tahnaw7Osw0A=" crossorigin="anonymous" async></script>
      
    
      

      
      

      
    
      

      
      

      
    
      

      
      
        
      

      
    
      

      
      

      
    

  

  
  
  
  <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Montserrat:400,700%7CRoboto:400,400italic,700%7CRoboto+Mono&display=swap">
  

  
  
  
  
  <link rel="stylesheet" href="/css/academic.css">

  





<script async src="https://www.googletagmanager.com/gtag/js?id=UA-34570499-2"></script>
<script>
  window.dataLayer = window.dataLayer || [];

  function gtag() {
      dataLayer.push(arguments);
  }

  function trackOutboundLink(url, target) {
    gtag('event', 'click', {
         'event_category': 'outbound',
         'event_label': url,
         'transport_type': 'beacon',
         'event_callback': function () {
           if (target !== '_blank') {
             document.location = url;
           }
         }
    });
    console.debug("Outbound link clicked: " + url);
  }

  function onClickCallback(event) {
    if ((event.target.tagName !== 'A') || (event.target.host === window.location.host)) {
      return;
    }
    trackOutboundLink(event.target, event.target.getAttribute('target'));  
  }

  gtag('js', new Date());
  gtag('config', 'UA-34570499-2', {});

  
  document.addEventListener('click', onClickCallback, false);
</script>


  


  

  <link rel="manifest" href="/index.webmanifest">
  <link rel="icon" type="image/png" href="/images/icon_hu6034018d2bd3ec10a6270f0656007019_39811_32x32_fill_box_center_2.png">
  <link rel="apple-touch-icon" type="image/png" href="/images/icon_hu6034018d2bd3ec10a6270f0656007019_39811_192x192_fill_box_center_2.png">

  <link rel="canonical" href="https://davidbieber.com/snippets/2021-01-30-sql-for-the-kangaroo-auto-responder/">

  
  
  
  
  
    
    
  
  
  <meta property="twitter:card" content="summary">
  
  <meta property="twitter:site" content="@Bieber">
  <meta property="twitter:creator" content="@Bieber">
  
  <meta property="og:site_name" content="David Bieber">
  <meta property="og:url" content="https://davidbieber.com/snippets/2021-01-30-sql-for-the-kangaroo-auto-responder/">
  <meta property="og:title" content="SQL for the Kangaroo Auto-responder | David Bieber">
  <meta property="og:description" content="I turned on the Kangaroo Auto-responder this morning. The rules for when to send a kangaroo ðŸ¦˜ are as follows:
You get a kangaroo if theÂ most-recentÂ message in our chat (ignoring trivial messages from you) isÂ non-trivial,Â read-by-me,Â written-by-you,Â not a response, andÂ eight-hours old.
Let&rsquo;s look at each of these criteria in more detail.
Most-recent message The criteria are being applied to the most recent message in our chat ignoring trivial messages from you."><meta property="og:image" content="img/map[gravatar:%!s(bool=true) shape:circle]">
  <meta property="twitter:image" content="img/map[gravatar:%!s(bool=true) shape:circle]"><meta property="og:locale" content="en-us">
  
    
      <meta property="article:published_time" content="2021-01-30T00:00:00&#43;00:00">
    
    <meta property="article:modified_time" content="2021-01-30T00:00:00&#43;00:00">
  

  



  


  


  





  <title>SQL for the Kangaroo Auto-responder | David Bieber</title>

</head>

<body id="top" data-spy="scroll" data-offset="70" data-target="#TableOfContents" >

  <aside class="search-results" id="search">
  <div class="container">
    <section class="search-header">

      <div class="row no-gutters justify-content-between mb-3">
        <div class="col-6">
          <h1>Search</h1>
        </div>
        <div class="col-6 col-search-close">
          <a class="js-search" href="#"><i class="fas fa-times-circle text-muted" aria-hidden="true"></i></a>
        </div>
      </div>

      <div id="search-box">
        
        <input name="q" id="search-query" placeholder="Search..." autocapitalize="off"
        autocomplete="off" autocorrect="off" spellcheck="false" type="search">
        
      </div>

    </section>
    <section class="section-search-results">

      <div id="search-hits">
        
      </div>

    </section>
  </div>
</aside>


  







<nav class="navbar navbar-expand-lg navbar-light compensate-for-scrollbar" id="navbar-main">
  <div class="container">

    
    <div class="d-none d-lg-inline-flex">
      <a class="navbar-brand" href="/">David Bieber</a>
    </div>
    

    
    <button type="button" class="navbar-toggler" data-toggle="collapse"
            data-target="#navbar-content" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
    <span><i class="fas fa-bars"></i></span>
    </button>
    

    
    <div class="navbar-brand-mobile-wrapper d-inline-flex d-lg-none">
      <a class="navbar-brand" href="/">David Bieber</a>
    </div>
    

    
    
    <div class="navbar-collapse main-menu-item collapse justify-content-end" id="navbar-content">

      
      <ul class="navbar-nav d-md-inline-flex">
        

        

        
        
        

        
        
        
        
        
        

        <li class="nav-item">
          <a class="nav-link  active" href="/"><span>Home</span></a>
        </li>

        
        

        

        
        
        
          
        

        
        
        
        
        
        

        <li class="nav-item">
          <a class="nav-link " href="/posts"><span>Writing</span></a>
        </li>

        
        

        

        
        
        
          
        

        
        
        
        
        
        

        <li class="nav-item">
          <a class="nav-link " href="/projects"><span>Projects</span></a>
        </li>

        
        

      

        
      </ul>
    </div>

    <ul class="nav-icons navbar-nav flex-row ml-auto d-flex pl-md-2">
      
      <li class="nav-item">
        <a class="nav-link js-search" href="#"><i class="fas fa-search" aria-hidden="true"></i></a>
      </li>
      

      

      

    </ul>

  </div>
</nav>


  <article class="article">

  












  

  
  
  
<div class="article-container pt-3">
  <h1 itemprop="name">SQL for the Kangaroo Auto-responder</h1>

  

  
    


<div class="article-metadata">

  
  

  
  <span class="article-date">
    
    
      
    
    
  </span>
  

  

  

  
  
  

  
  

</div>

  
</div>




  <div class="article-container">

    <div class="article-style" id="article-content">
      <p>I turned on the 
<a href="/snippets/2021-01-29-kangaroo-auto-responder/">Kangaroo Auto-responder</a> this morning. The rules for when to send a kangaroo ðŸ¦˜ are as follows:</p>
<p>You get a kangaroo if theÂ <strong>most-recent</strong>Â message in our chat (ignoring trivial messages from you) isÂ <strong>non-trivial</strong>,Â <strong>read-by-me</strong>,Â <strong>written-by-you</strong>,Â <strong>not a response</strong>, andÂ <strong>eight-hours old</strong>.</p>
<p>Let&rsquo;s look at each of these criteria in more detail.</p>
<h2 id="most-recent-message">Most-recent message</h2>
<p>The criteria are being applied to the most recent message in our chat ignoring trivial messages from you.</p>
<p>In SQL, this looks like</p>
<pre><code class="language-sql">select thread_id, max(timestamp) as timestamp
from messenger
where (author = '1409114395' or (author &lt;&gt; '1409114395' and LENGTH(text) &gt; 15))
group by thread_id;
</code></pre>
<p>1409114395 is my Facebook ID.</p>
<p>This query selects the most recent timestamp from only a single message in each thread. It considers all messages from me, but only non-trivial (more than 15 characters) messages from the other participant.</p>
<p>The reason for this is that if I have sent the most recent message in a conversation (regardless of the length of the message), then no kangaroo is needed. If the other person has sent the most recent message, a kangaroo might be in order, but trivial messages should not trigger kangaroos. So we ignore them, and see if the most recent message is still from the other person even when ignoring their trivial messages.</p>
<h2 id="non-trivial">Non-trivial</h2>
<p>We choose 15-characters as the threshold for what makes a message trivial. The reason we ignore trivial messages is because they often don&rsquo;t warrant a response. I am considering removing this constraint, as the &ldquo;Not a response&rdquo; constraint seems to obviate the need for it.</p>
<p>This shows up as <code>LENGTH(text) &gt; 15)</code> in the query.</p>
<h2 id="read-by-me">Read-by-me</h2>
<p>Unfortunately I do not have read receipt information in my messages database, so I did not include this rule in the first version of the Kangaroo Auto-responder.</p>
<h2 id="written-by-you">Written-by-you</h2>
<p>Only if the most recent message is from you is a kangaroo necessary. If its from me, I&rsquo;ve already responded!</p>
<p>In this query, this is a simple check:</p>
<pre><code class="language-sql">WHERE messenger.author &lt;&gt; '1409114395'
</code></pre>
<h2 id="not-a-response">Not-a-response</h2>
<p>This is an interesting piece. When I wrote out the rules for the auto-responder yesterday, I was thinking I&rsquo;d ignore messages sent within 5 minutes of a message I sent. My thinking was that this small filter would prevent me from needing to get the last word in every conversation to avoid oversending of kangaroos.</p>
<p>Now, I&rsquo;m thinking I&rsquo;ll ignore messages sent within <em>36 hours</em> of a message I sent. This is a much tighter restriction. It means that I may miss sending some kangaroos that I ought to have sent, but it also means that if someone takes two hours to reply to me and that&rsquo;s the end of the conversation, I don&rsquo;t need to reply to prevent a kangaroo from going out.</p>
<p>It seems like striking a good balance between the non-trivial message criteria and the not-a-response criteria is key, and I may adjust these going forward.</p>
<p>To determine if a message is a response, I first determine the time of my own most recent message in the chat. In SQL, this is:</p>
<pre><code class="language-sql">select thread_id, max(timestamp) as outgoing_timestamp
from messenger
where author = '1409114395' -- my FB id
group by thread_id;
</code></pre>
<p>I then compare this message&rsquo;s timestamp with that of the most recent message in the thread, which we selected earlier:</p>
<pre><code class="language-sql">(  -- The reply is at least X minutes after my latest message.
  (latest_messages.timestamp - outgoing_timestamp)/1000 &gt; 36*60*60
  or outgoing_timestamp IS NULL
)
</code></pre>
<h2 id="8-hours-old">8-hours old</h2>
<p>The final criteria for whether to send a kangaroo is that the message must be eight hours old. Yesterday I was initially planning for 2-hours old, but I decided to give myself more time to respond manually before the kangaroo would go out. Here&rsquo;s the SQL for that:</p>
<pre><code class="language-sql">-- Message is 8 hours old:
AND NOW() - to_timestamp(messenger.timestamp/1000) at time zone 'UTC' &gt; INTERVAL '8 HOURS'
AND NOW() - to_timestamp(messenger.timestamp/1000) at time zone 'UTC' &lt; INTERVAL '8.25 HOURS'

</code></pre>
<h2 id="putting-it-all-together">Putting it all together</h2>
<p>Here&rsquo;s the complete SQL query that finds messages which warrant an automated kangaroo response.</p>
<pre><code class="language-sql">-- Select the most recent message per thread
-- (ignoring trivial messages from you),
-- and the most recent message per thread specifically from me.
-- If the most recent message (ignoring trivial messages from you)
-- is non-trivial,
-- written-by-you,
-- not a reply to my message,
-- and a specific age,
-- then we've got ourselves a Kangaroo!
--
-- In a future iteration we will also ensure the message has been read-by-me.

SELECT * FROM

-- The first sub-query:
-- Selects the most recent message from each thread that is either:
-- (A) from me, or (B) from you and non-trivial in length
-- And is also less than 8 hours old.
((select thread_id, max(timestamp) as timestamp
 from messenger
 where (author = '1409114395' or (author &lt;&gt; '1409114395' and LENGTH(text) &gt; 15))
 -- and to_timestamp(timestamp/1000) at time zone 'UTC' &gt; NOW() - INTERVAL '800 HOURS'
 group by thread_id) AS latest_messages
INNER JOIN
  messenger
ON
  messenger.thread_id = latest_messages.thread_id AND
  messenger.timestamp = latest_messages.timestamp)
LEFT JOIN
    -- Selects the most recent message from each thread from me:
    (select thread_id, max(timestamp) as outgoing_timestamp
     from messenger
     where author = '1409114395'
     -- and to_timestamp(timestamp/1000) at time zone 'UTC' &gt; NOW() - INTERVAL '800 HOURS'
     group by thread_id) AS latest_outgoing_messages
ON
  messenger.thread_id = latest_outgoing_messages.thread_id
WHERE messenger.author &lt;&gt; '1409114395' -- David Bieber
AND messenger.author &lt;&gt; '1985867351654140' -- Bieber Bot
AND (  -- The reply is at least X minutes after my latest message.
  (latest_messages.timestamp - outgoing_timestamp)/1000 &gt; 36*60*60
  or outgoing_timestamp IS NULL
)
AND thread_type = 'USER' -- Message is a 1:1 chat, not a group chat
-- Message is 8 hours old:
AND NOW() - to_timestamp(messenger.timestamp/1000) at time zone 'UTC' &gt; INTERVAL '8 HOURS'
AND NOW() - to_timestamp(messenger.timestamp/1000) at time zone 'UTC' &lt; INTERVAL '8.25 HOURS'
ORDER BY messenger.timestamp desc;
</code></pre>
<p>This checks all the criteria for whether a message needs a kangaroo. I&rsquo;ve set up a script that runs this query every ten minutes, and sends kangaroos as necessary.</p>
<p>At the time of this writing, no kangaroos have been sent yet. I hope it works ðŸ¤ž!</p>

    </div>

    





<div class="article-tags">
  
  <a class="badge badge-light" href="/tags/sql/">sql</a>
  
  <a class="badge badge-light" href="/tags/python/">python</a>
  
  <a class="badge badge-light" href="/tags/taking-silly-ideas-seriously/">taking-silly-ideas-seriously</a>
  
</div>










  
  
  <div class="article-widget content-widget-hr">
    <h3>Related</h3>
    <ul>
      
      <li><a href="/snippets/2021-01-29-kangaroo-auto-responder/">Kangaroo Auto-responder</a></li>
      
      <li><a href="/snippets/2021-02-17-python-magic-functions/">Magic Functions in Python</a></li>
      
      <li><a href="/snippets/2021-01-18-python-hoist-locals-only/">Python hoist: immediate locals only</a></li>
      
      <li><a href="/snippets/2021-01-16-python-hoist/">Python hoist()</a></li>
      
    </ul>
  </div>
  












  
  





  
  
  
    
  
  
  
  <div class="media author-card content-widget-hr">
    

    <div class="media-body">
      <h5 class="card-title"><a href="https://davidbieber.com/">David Bieber</a></h5>
      
      
      <ul class="network-icon" aria-hidden="true">
  
</ul>

    </div>
  </div>








  </div>
</article>

      

    
    
    
      <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js" integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo=" crossorigin="anonymous"></script>
      <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery.imagesloaded/4.1.4/imagesloaded.pkgd.min.js" integrity="sha256-lqvxZrPLtfffUl2G/e7szqSvPBILGbwmsGE1MKlOi0Q=" crossorigin="anonymous"></script>
      <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery.isotope/3.0.6/isotope.pkgd.min.js" integrity="sha256-CBrpuqrMhXwcLLUd5tvQ4euBHCdh7wGlDfNz8vbu/iI=" crossorigin="anonymous"></script>
      <script src="https://cdnjs.cloudflare.com/ajax/libs/fancybox/3.5.7/jquery.fancybox.min.js" integrity="sha256-yt2kYMy0w8AbtF89WXb2P1rfjcP/HTHLT7097U8Y5b8=" crossorigin="anonymous"></script>

      

      
        
        <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.18.1/highlight.min.js" integrity="sha256-eOgo0OtLL4cdq7RdwRUiGKLX9XsIJ7nGhWEKbohmVAQ=" crossorigin="anonymous"></script>
        
        <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.18.1/languages/python.min.js"></script>
        
        <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.18.1/languages/javascript.min.js"></script>
        
      

    

    
    

    
    
    <script>const code_highlighting = true;</script>
    

    
    
    <script>const isSiteThemeDark = false;</script>
    

    
    
    
    
    
    
    <script>
      const search_config = {"indexURI":"/index.json","minLength":1,"threshold":0.3};
      const i18n = {"no_results":"No results found","placeholder":"Search...","results":"results found"};
      const content_type = {
        'post': "Posts",
        'project': "Projects",
        'publication' : "Publications",
        'talk' : "Talks"
        };
    </script>
    

    
    

    
    
    <script id="search-hit-fuse-template" type="text/x-template">
      <div class="search-hit" id="summary-{{key}}">
      <div class="search-hit-content">
        <div class="search-hit-name">
          <a href="{{relpermalink}}">{{title}}</a>
          <div class="article-metadata search-hit-type">{{type}}</div>
          <p class="search-hit-description">{{snippet}}</p>
        </div>
      </div>
      </div>
    </script>
    

    
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/fuse.js/3.2.1/fuse.min.js" integrity="sha256-VzgmKYmhsGNNN4Ph1kMW+BjoYJM2jV5i4IlFoeZA9XI=" crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/mark.js/8.11.1/jquery.mark.min.js" integrity="sha256-4HLtjeVgH0eIB3aZ9mLYF6E8oU5chNdjU6p6rrXpl9U=" crossorigin="anonymous"></script>
    

    
    

    
    

    
    
    
    
    
    
    
    
    
      
    
    
    
    

    <script crossorigin src="//unpkg.com/react@16/umd/react.production.min.js"></script>
<script crossorigin src="//unpkg.com/react-dom@16/umd/react-dom.production.min.js"></script>

<script src="/js/academic.min.c816d323c3a55093dae0829b44ea1ca8.js"></script>

<script src="//code.jquery.com/jquery-3.4.1.min.js"></script>
<script src="//static.tumblr.com/fpifyru/AKFlv9zdu/embedgist.js"></script>


<script src="//www.gstatic.com/firebasejs/7.6.2/firebase-app.js"></script>
<script src="//www.gstatic.com/firebasejs/7.6.2/firebase-analytics.js"></script>
<script src="//www.gstatic.com/firebasejs/7.6.2/firebase-firestore.js"></script>

<script>
  var firebaseConfig = {
    apiKey: "AIzaSyDZSDKaAmz-UUyaL1IZMi4QO_q4Jouko2c",
    authDomain: "ask-me-anywhere.firebaseapp.com",
    databaseURL: "https://ask-me-anywhere.firebaseio.com",
    projectId: "ask-me-anywhere",
    storageBucket: "ask-me-anywhere.appspot.com",
    messagingSenderId: "123038093749",
    appId: "1:123038093749:web:e8ce89651fcf1371d109fc",
    measurementId: "G-JLDGL73R1B"
  };
  
  firebase.initializeApp(firebaseConfig);
  firebase.analytics();
</script>

    



  
  
  <div class="container">
    <footer class="site-footer">
  

  <p class="powered-by">
    

    

    
    <span class="float-right" aria-hidden="true">
      <a href="#" class="back-to-top">
        <span class="button_icon">
          <i class="fas fa-chevron-up fa-2x"></i>
        </span>
      </a>
    </span>
    
  </p>
</footer>

  </div>
  

  
<div id="modal" class="modal fade" role="dialog">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Cite</h5>
        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body">
        <pre><code class="tex hljs"></code></pre>
      </div>
      <div class="modal-footer">
        <a class="btn btn-outline-primary my-1 js-copy-cite" href="#" target="_blank">
          <i class="fas fa-copy"></i> Copy
        </a>
        <a class="btn btn-outline-primary my-1 js-download-cite" href="#" target="_blank">
          <i class="fas fa-download"></i> Download
        </a>
        <div id="modal-error"></div>
      </div>
    </div>
  </div>
</div>

</body>
</html>
